AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Bootstrap infrastructure for EKS Upgrade Automation.
  Creates: S3 bucket, GitHub OIDC provider, deployer IAM role,
  VPC networking, EKS dev cluster with managed node group.
  Deploy this stack ONCE before using the main deploy.yml workflow.

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: Environment name (used for resource naming and tagging)

  S3BucketName:
    Type: String
    Default: ''
    Description: >-
      Explicit S3 bucket name. Leave blank to auto-generate as
      eks-upgrade-automation-{AccountId}-{Region}

  GitHubOrg:
    Type: String
    Description: GitHub organization or username (e.g., berry2012)

  GitHubRepo:
    Type: String
    Default: automate-eks-upgrades
    Description: GitHub repository name

  CreateOIDCProvider:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: >-
      Create GitHub Actions OIDC provider. Set to false if your account
      already has a GitHub OIDC provider registered.

  EKSClusterVersion:
    Type: String
    Default: '1.31'
    Description: Kubernetes version for the EKS dev cluster

  VpcCidr:
    Type: String
    Default: '10.0.0.0/16'
    Description: CIDR block for the VPC

  NodeInstanceType:
    Type: String
    Default: t3.medium
    Description: EC2 instance type for managed node group

  NodeDesiredSize:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 10
    Description: Desired number of worker nodes

  NodeMinSize:
    Type: Number
    Default: 1
    MinValue: 1
    MaxValue: 10
    Description: Minimum number of worker nodes

  NodeMaxSize:
    Type: Number
    Default: 4
    MinValue: 1
    MaxValue: 20
    Description: Maximum number of worker nodes

Conditions:
  HasCustomBucketName: !Not [!Equals [!Ref S3BucketName, '']]
  ShouldCreateOIDCProvider: !Equals [!Ref CreateOIDCProvider, 'true']

Resources:
  # ──────────────────────────────────────────────────────────────────
  # S3 Bucket — stores Lambda code packages and CloudFormation templates
  # ──────────────────────────────────────────────────────────────────
  ArtifactBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !If
        - HasCustomBucketName
        - !Ref S3BucketName
        - !Sub 'eks-upgrade-automation-${AWS::AccountId}-${AWS::Region}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: automate-eks-upgrades

  ArtifactBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ArtifactBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: '*'
            Action: s3:*
            Resource:
              - !GetAtt ArtifactBucket.Arn
              - !Sub '${ArtifactBucket.Arn}/*'
            Condition:
              Bool:
                aws:SecureTransport: 'false'

  # ──────────────────────────────────────────────────────────────────
  # GitHub Actions OIDC Provider
  # ──────────────────────────────────────────────────────────────────
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Condition: ShouldCreateOIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1
        - 1c58a3a8518e8759bf075b76b750d4f2df264fcd
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: automate-eks-upgrades

  # ──────────────────────────────────────────────────────────────────
  # Deployer IAM Role — assumed by GitHub Actions via OIDC
  # ──────────────────────────────────────────────────────────────────
  DeployerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-deployer-role'
      Description: Role assumed by GitHub Actions to deploy EKS Upgrade Automation
      MaxSessionDuration: 3600
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !If
                - ShouldCreateOIDCProvider
                - !GetAtt GitHubOIDCProvider.Arn
                - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:oidc-provider/token.actions.githubusercontent.com'
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              StringLike:
                token.actions.githubusercontent.com:sub: !Sub 'repo:${GitHubOrg}/${GitHubRepo}:*'
      ManagedPolicyArns:
        - !Ref DeployerManagedPolicy
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: automate-eks-upgrades

  # ──────────────────────────────────────────────────────────────────
  # Deployer Managed Policy — minimum permissions for deployment
  # ──────────────────────────────────────────────────────────────────
  DeployerManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${AWS::StackName}-deployer-policy'
      Description: >-
        Permissions required to deploy the EKS Upgrade Automation stack
        via CloudFormation, including Lambda, IAM, SNS, Scheduler, and S3.
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # CloudFormation stack management
          - Sid: CloudFormation
            Effect: Allow
            Action:
              - cloudformation:CreateStack
              - cloudformation:UpdateStack
              - cloudformation:DeleteStack
              - cloudformation:DescribeStacks
              - cloudformation:DescribeStackEvents
              - cloudformation:DescribeStackResources
              - cloudformation:GetTemplate
              - cloudformation:GetTemplateSummary
              - cloudformation:ValidateTemplate
              - cloudformation:ListStacks
              - cloudformation:CreateChangeSet
              - cloudformation:DescribeChangeSet
              - cloudformation:ExecuteChangeSet
              - cloudformation:DeleteChangeSet
            Resource: '*'

          # S3 — upload Lambda code and CloudFormation templates
          - Sid: S3Artifacts
            Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetObject
              - s3:GetBucketLocation
              - s3:ListBucket
            Resource:
              - !GetAtt ArtifactBucket.Arn
              - !Sub '${ArtifactBucket.Arn}/*'

          # Lambda function management
          - Sid: Lambda
            Effect: Allow
            Action:
              - lambda:CreateFunction
              - lambda:UpdateFunctionCode
              - lambda:UpdateFunctionConfiguration
              - lambda:DeleteFunction
              - lambda:GetFunction
              - lambda:GetFunctionConfiguration
              - lambda:AddPermission
              - lambda:RemovePermission
              - lambda:ListTags
              - lambda:TagResource
              - lambda:UntagResource
              - lambda:PutFunctionConcurrency
              - lambda:DeleteFunctionConcurrency
            Resource:
              - !Sub 'arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:eks-version-checker'
              - !Sub 'arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:eks-nodegroup-version-manager'

          # IAM role and policy management (for Lambda execution roles)
          - Sid: IAMRoles
            Effect: Allow
            Action:
              - iam:CreateRole
              - iam:DeleteRole
              - iam:GetRole
              - iam:UpdateRole
              - iam:PassRole
              - iam:PutRolePolicy
              - iam:GetRolePolicy
              - iam:DeleteRolePolicy
              - iam:AttachRolePolicy
              - iam:DetachRolePolicy
              - iam:ListRolePolicies
              - iam:ListAttachedRolePolicies
              - iam:TagRole
              - iam:UntagRole
            Resource:
              - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:role/eks-addon-management-*'
              - !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${AWS::StackName}-*'

          # SNS topic management
          - Sid: SNS
            Effect: Allow
            Action:
              - sns:CreateTopic
              - sns:DeleteTopic
              - sns:Subscribe
              - sns:Unsubscribe
              - sns:GetTopicAttributes
              - sns:SetTopicAttributes
              - sns:ListSubscriptionsByTopic
              - sns:TagResource
              - sns:UntagResource
            Resource:
              - !Sub 'arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:eks-upgrade-notifications'

          # EventBridge Scheduler management
          - Sid: Scheduler
            Effect: Allow
            Action:
              - scheduler:CreateSchedule
              - scheduler:UpdateSchedule
              - scheduler:DeleteSchedule
              - scheduler:GetSchedule
              - scheduler:ListSchedules
              - scheduler:TagResource
              - scheduler:UntagResource
            Resource:
              - !Sub 'arn:${AWS::Partition}:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/eks-version-checker-weekly'
              - !Sub 'arn:${AWS::Partition}:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/eks-nodegroup-manager-weekly'

          # CloudWatch Logs — view Lambda execution logs
          - Sid: CloudWatchLogs
            Effect: Allow
            Action:
              - logs:DescribeLogGroups
              - logs:DescribeLogStreams
              - logs:GetLogEvents
              - logs:FilterLogEvents
            Resource:
              - !Sub 'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/eks-version-checker:*'
              - !Sub 'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/eks-nodegroup-version-manager:*'

  # ════════════════════════════════════════════════════════════════
  #  VPC NETWORKING
  # ════════════════════════════════════════════════════════════════

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-eks-vpc'
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: automate-eks-upgrades

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-eks-igw'

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Public subnets (across 2 AZs — required by EKS)
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [0, !Cidr [!Ref VpcCidr, 4, 8]]
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-public-a'
        - Key: kubernetes.io/role/elb
          Value: '1'

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Select [1, !Cidr [!Ref VpcCidr, 4, 8]]
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-public-b'
        - Key: kubernetes.io/role/elb
          Value: '1'

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetARouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  SubnetBRouteTableAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  # ════════════════════════════════════════════════════════════════
  #  EKS CLUSTER
  # ════════════════════════════════════════════════════════════════

  EKSClusterRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${Environment}-eks-cluster-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEKSClusterPolicy'
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEKSServicePolicy'
      Tags:
        - Key: Environment
          Value: !Ref Environment

  EKSClusterSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub 'Security group for ${Environment} EKS cluster'
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-eks-cluster-sg'

  EKSDevCluster:
    Type: AWS::EKS::Cluster
    DependsOn: VPCGatewayAttachment
    Properties:
      Name: !Sub '${Environment}-dev-cluster'
      Version: !Ref EKSClusterVersion
      RoleArn: !GetAtt EKSClusterRole.Arn
      ResourcesVpcConfig:
        SubnetIds:
          - !Ref PublicSubnetA
          - !Ref PublicSubnetB
        SecurityGroupIds:
          - !Ref EKSClusterSecurityGroup
        EndpointPublicAccess: true
        EndpointPrivateAccess: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub '${Environment}-dev-cluster'

  # ════════════════════════════════════════════════════════════════
  #  MANAGED NODE GROUP
  # ════════════════════════════════════════════════════════════════

  NodeGroupRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${Environment}-eks-nodegroup-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEKSWorkerNodePolicy'
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEKS_CNI_Policy'
        - !Sub 'arn:${AWS::Partition}:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly'
      Policies:
        - PolicyName: ClusterAutoscalerPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - autoscaling:DescribeAutoScalingGroups
                  - autoscaling:DescribeAutoScalingInstances
                  - autoscaling:DescribeLaunchConfigurations
                  - autoscaling:DescribeScalingActivities
                  - autoscaling:DescribeTags
                  - ec2:DescribeImages
                  - ec2:DescribeInstanceTypes
                  - ec2:DescribeLaunchTemplateVersions
                  - ec2:GetInstanceTypesFromInstanceRequirements
                  - eks:DescribeNodegroup
                Resource: '*'
              - Effect: Allow
                Action:
                  - autoscaling:SetDesiredCapacity
                  - autoscaling:TerminateInstanceInAutoScalingGroup
                Resource: !Sub 'arn:${AWS::Partition}:autoscaling:${AWS::Region}:${AWS::AccountId}:autoScalingGroup:*:autoScalingGroupName/*'
      Tags:
        - Key: Environment
          Value: !Ref Environment

  DevNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn: EKSDevCluster
    Properties:
      ClusterName: !Sub '${Environment}-dev-cluster'
      NodegroupName: !Sub '${Environment}-dev-nodegroup'
      NodeRole: !GetAtt NodeGroupRole.Arn
      Subnets:
        - !Ref PublicSubnetA
        - !Ref PublicSubnetB
      InstanceTypes:
        - !Ref NodeInstanceType
      ScalingConfig:
        DesiredSize: !Ref NodeDesiredSize
        MinSize: !Ref NodeMinSize
        MaxSize: !Ref NodeMaxSize
      AmiType: AL2_x86_64
      DiskSize: 20
      Tags:
        Environment: !Ref Environment
        Name: !Sub '${Environment}-dev-nodegroup'

  # ════════════════════════════════════════════════════════════════
  #  CLUSTER AUTOSCALER IAM (IRSA)
  # ════════════════════════════════════════════════════════════════

  ClusterAutoscalerRole:
    Type: AWS::IAM::Role
    DependsOn: EKSDevCluster
    Properties:
      RoleName: !Sub '${Environment}-cluster-autoscaler-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com
            Action: sts:AssumeRole
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: ClusterAutoscalerPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - autoscaling:DescribeAutoScalingGroups
                  - autoscaling:DescribeAutoScalingInstances
                  - autoscaling:DescribeLaunchConfigurations
                  - autoscaling:DescribeScalingActivities
                  - autoscaling:DescribeTags
                  - ec2:DescribeImages
                  - ec2:DescribeInstanceTypes
                  - ec2:DescribeLaunchTemplateVersions
                  - ec2:GetInstanceTypesFromInstanceRequirements
                  - eks:DescribeNodegroup
                Resource: '*'
              - Effect: Allow
                Action:
                  - autoscaling:SetDesiredCapacity
                  - autoscaling:TerminateInstanceInAutoScalingGroup
                Resource: !Sub 'arn:${AWS::Partition}:autoscaling:${AWS::Region}:${AWS::AccountId}:autoScalingGroup:*:autoScalingGroupName/*'
      Tags:
        - Key: Environment
          Value: !Ref Environment

Outputs:
  ArtifactBucketName:
    Description: S3 bucket name for deployment artifacts (use as S3_BUCKET in deploy workflow)
    Value: !Ref ArtifactBucket
    Export:
      Name: !Sub '${AWS::StackName}-artifact-bucket'

  DeployerRoleArn:
    Description: Deployer IAM role ARN (use as AWS_ROLE_ARN secret in GitHub)
    Value: !GetAtt DeployerRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-deployer-role-arn'

  DeployerPolicyArn:
    Description: Deployer managed policy ARN
    Value: !Ref DeployerManagedPolicy

  OIDCProviderArn:
    Condition: ShouldCreateOIDCProvider
    Description: GitHub Actions OIDC provider ARN
    Value: !GetAtt GitHubOIDCProvider.Arn

  VpcId:
    Description: VPC ID for the EKS cluster
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-vpc-id'

  EKSClusterName:
    Description: EKS dev cluster name (tagged for automation discovery)
    Value: !Ref EKSDevCluster
    Export:
      Name: !Sub '${AWS::StackName}-eks-cluster-name'

  EKSClusterEndpoint:
    Description: EKS cluster API endpoint
    Value: !GetAtt EKSDevCluster.Endpoint

  EKSClusterVersion:
    Description: Kubernetes version running on the cluster
    Value: !Ref EKSClusterVersion

  NodeGroupName:
    Description: Managed node group name
    Value: !Sub '${Environment}-dev-nodegroup'

  ClusterAutoscalerRoleArn:
    Description: IAM role ARN for the Cluster Autoscaler
    Value: !GetAtt ClusterAutoscalerRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-cluster-autoscaler-role-arn'
